<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>JARVIS Envie ‚Äì Scan & Cr√©ation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Librairie de scan live QR / codes-barres -->
    <script
      src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"
      type="text/javascript"
    ></script>

    <style>
      :root {
        /* Palette Envie */
        --envie-vert-fonce: #00463c;
        --envie-vert-moyen: #237031;
        --envie-vert-clair: #c7e1bc;
        --envie-orange: #ea5c10;

        --bg-page: #f4f5f7;
        --bg-card: #ffffff;
        --border-soft: #d0d4da;
        --text-main: #1f2933;
        --text-muted: #4b5563;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 0.8rem;
        background: var(--bg-page);
        color: var(--text-main);
      }

      /* Bandeau haut JARVIS / Envie */
      .topbar {
        background: var(--envie-vert-fonce);
        color: #ffffff;
        padding: 0.6rem 0.8rem;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.18);
        margin-bottom: 0.8rem;
      }

      .topbar-main {
        display: flex;
        flex-direction: column;
      }

      .topbar-title {
        font-weight: 650;
        font-size: 1rem;
        letter-spacing: 0.02em;
      }

      .topbar-subtitle {
        font-size: 0.75rem;
        opacity: 0.9;
      }

      .topbar-tag {
        font-size: 0.65rem;
        text-transform: uppercase;
        border-radius: 999px;
        padding: 0.15rem 0.5rem;
        border: 1px solid rgba(255, 255, 255, 0.4);
      }

      .topbar-badge {
        background: var(--envie-orange);
        color: #ffffff;
        font-size: 0.7rem;
        font-weight: 600;
        border-radius: 999px;
        padding: 0.25rem 0.6rem;
        white-space: nowrap;
      }

      h1 {
        margin: 0.4rem 0 0.2rem;
        font-size: 1rem;
        color: var(--envie-vert-fonce);
      }

      p.lead {
        font-size: 0.8rem;
        margin: 0 0 0.7rem;
        color: var(--text-muted);
      }

      .card {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 0.8rem;
        margin-bottom: 0.8rem;
        box-shadow: 0 2px 7px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(0, 0, 0, 0.03);
      }

      h2 {
        font-size: 0.95rem;
        margin: 0 0 0.4rem;
        color: var(--envie-vert-fonce);
      }

      h3 {
        font-size: 0.9rem;
        margin-bottom: 0.3rem;
        color: var(--envie-vert-moyen);
      }

      label {
        display: block;
        font-size: 0.8rem;
        margin-top: 0.4rem;
        color: var(--text-main);
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 0.4rem 0.5rem;
        margin-top: 0.2rem;
        border-radius: 8px;
        border: 1px solid var(--border-soft);
        font-size: 0.85rem;
        background: #ffffff;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: 2px solid var(--envie-vert-moyen);
        outline-offset: 1px;
        border-color: var(--envie-vert-moyen);
      }

      button {
        margin-top: 0.4rem;
        padding: 0.5rem 0.8rem;
        border-radius: 999px;
        border: none;
        font-size: 0.9rem;
        cursor: pointer;
        background: var(--envie-vert-moyen);
        color: #ffffff;
        font-weight: 550;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
      }

      button.secondary {
        background: transparent;
        color: var(--envie-vert-fonce);
        border: 1px solid var(--envie-vert-fonce);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-block {
        width: 100%;
        justify-content: center;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.6rem;
      }

      .row-vertical {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        margin-top: 0.4rem;
      }

      .result {
        margin-top: 0.5rem;
        padding: 0.5rem 0.6rem;
        font-size: 0.8rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        white-space: pre-wrap;
        color: #1f2933;
      }

      .helper-text {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.2rem;
      }

      .scan-live-container {
        margin-top: 0.4rem;
        padding: 0.4rem;
        border-radius: 10px;
        background: #f1f5f9;
        border: 1px dashed #94a3b8;
      }

      #scan_live_view {
        width: 100%;
        max-width: 320px;
        margin: 0 auto;
      }

      .pill {
        display: inline-block;
        padding: 0.15rem 0.45rem;
        border-radius: 999px;
        font-size: 0.7rem;
        margin-right: 0.3rem;
        margin-top: 0.2rem;
        background: #e2f4ec;
        color: var(--envie-vert-fonce);
      }

      .pill.gray {
        background: #e2e8f0;
        color: #334155;
      }

      /* Mobile first */
      @media (max-width: 700px) {
        .row {
          grid-template-columns: 1fr;
        }

        .topbar {
          flex-direction: column;
          align-items: flex-start;
        }

        button {
          width: 100%;
        }
      }

      /* Confort √©cran large */
      @media (min-width: 1000px) {
        body {
          max-width: 1100px;
          margin: 0 auto;
          padding: 1rem 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Bandeau haut JARVIS / Envie -->
    <header class="topbar">
      <div class="topbar-main">
        <div class="topbar-title">JARVIS ¬∑ Envie</div>
        <div class="topbar-subtitle">Tri & tra√ßabilit√© ‚Äì usage terrain simplifi√©</div>
      </div>
      <div>
        <div class="topbar-tag">Prototype v1</div>
        <div class="topbar-badge">L‚ÄôIA au service de l‚Äôinsertion</div>
      </div>
    </header>

    <h1>Collecte produit ‚Äì Page 1</h1>
    <p class="lead">
      1. Choisir un bouton<br />
      2. Scanner / prendre la photo<br />
      3. Laisser JARVIS remplir la fiche
    </p>

    <!-- Carte 1 : actions principales (AU DESSUS DE LA LIGNE DE FLOTTEMENT) -->
    <div class="card">
      <h2>1. Choisir l‚Äôaction</h2>

      <div class="row-vertical">
        <button type="button" id="btn_live_scan_traca" class="btn-block">
          üì¶ Scanner TRACA (code-barres)
        </button>
        <span class="helper-text">Scanner le code-barres Traca coll√© sur le produit.</span>

        <button type="button" id="btn_live_scan_dpp" class="btn-block secondary">
          üîó Scanner DPP (QR app)
        </button>
        <span class="helper-text">Scanner le QR de l‚Äôappareil (passeport num√©rique).</span>

        <button type="button" id="btn_photo" class="btn-block secondary">
          üì∏ Photo (plaque / QR / code-barres)
        </button>
        <span class="helper-text">
          Prendre une photo si le scan ne marche pas ou pour un traitement OCR.
        </span>
      </div>

      <!-- ID Traca + structure : juste en dessous pour rester visible -->
      <div class="row" style="margin-top:0.6rem;">
        <div>
          <label for="scan_id_traca">ID Traca (12 chiffres)</label>
          <input id="scan_id_traca" placeholder="ex : 170100000001" />
          <div class="helper-text">Peut √™tre rempli par le scan TRACA ou saisi √† la main.</div>
        </div>
        <div>
          <label for="scan_struct_op">Structure</label>
          <select id="scan_struct_op">
            <option value="1701">1701 ‚Äì Envie Dr√¥me Ard√®che</option>
            <option value="1001">1001 ‚Äì Envie Tourcoing</option>
          </select>
        </div>
      </div>

      <button id="btn_scan" class="btn-block" style="margin-top:0.6rem;">
        üîç V√©rifier l‚ÄôID Traca dans la base
      </button>

      <input
        type="file"
        id="photo_input"
        accept="image/*"
        capture="environment"
        style="display:none;"
      />

      <!-- Zone de scan live -->
      <div
        id="scan_live_container"
        class="scan-live-container"
        style="display:none;"
      >
        <div id="scan_live_view"></div>
        <div class="helper-text" id="scan_live_mode_label">Cadrez le code dans le carr√©.</div>
        <button
          type="button"
          id="btn_live_scan_stop"
          class="secondary btn-block"
          style="margin-top:0.4rem;"
        >
          ‚èπÔ∏è Arr√™ter le scan
        </button>
      </div>

      <!-- Messages simples -->
      <div id="scan_result" class="result" style="display:none;"></div>
    </div>

    <!-- Carte 2 : Fiche collecte produit depuis DPP / OCR -->
    <div class="card" id="card_fiche_dpp" style="display:none;">
      <h2>2. Fiche produit ‚Äì DPP / QR</h2>
      <p class="helper-text">
        JARVIS lit le contenu du DPP (ou de la photo) et propose une fiche simple. Le texte brut est
        affich√© en bas pour contr√¥le.
      </p>
      <div id="fiche_dpp" class="result"></div>
    </div>

    <!-- Carte 3 : R√©sultat base locale / droits -->
    <div class="card" id="card_produit" style="display:none;">
      <h2>3. R√©sultat base Traca</h2>
      <div id="produit_infos" class="result"></div>
    </div>

    <!-- Carte 4 : Cr√©ation produit (partie App) -->
    <div class="card" id="card_creation" style="display:none;">
      <h2>4. Cr√©ation / Compl√©tion du produit</h2>
      <p class="helper-text">
        Si le produit n‚Äôexiste pas dans la base, ou apr√®s un DPP, JARVIS te propose de compl√©ter la fiche.<br />
        Mode simple : choix AUTO (donn√©es propos√©es) ou MANUEL (tu remplis).
      </p>

      <div class="row">
        <div>
          <label for="cre_point_code">Point de collecte (code)</label>
          <input id="cre_point_code" placeholder="ex : PC01" />
        </div>
        <div>
          <label for="cre_point_lib">Point de collecte (nom)</label>
          <input id="cre_point_lib" placeholder="ex : Boulanger, D√©chetterie X‚Ä¶" />
        </div>
      </div>

      <p class="helper-text" style="margin-top:0.5rem;">
        <span class="pill">AUTO (DPP / OCR)</span>
        JARVIS remplit les champs. Tu v√©rifies.<br />
        <span class="pill gray">MANUEL</span>
        Tu remplis toi-m√™me.
      </p>

      <div class="row">
        <button class="secondary btn-block" id="btn_cre_auto">‚öôÔ∏è Mode AUTO</button>
        <button class="secondary btn-block" id="btn_cre_manuel">‚úçÔ∏è Mode MANUEL</button>
      </div>

      <!-- Sous-formulaire MANUEL -->
      <div id="bloc_cre_manuel" style="margin-top:0.6rem;display:none;">
        <h3>Mode MANUEL</h3>

        <label for="cre_flux">Flux (ex : GEMF)</label>
        <input id="cre_flux" placeholder="ex : GEMF" />

        <label for="cre_flux_sous">Sous-flux (ex : GEMHF)</label>
        <input id="cre_flux_sous" placeholder="ex : GEMHF" />

        <label for="cre_famille">Famille</label>
        <select id="cre_famille">
          <option value="">-- choisir --</option>
          <option value="Froid">Froid</option>
          <option value="Lavage">Lavage</option>
          <option value="Cuisson">Cuisson</option>
          <option value="PEM">PEM</option>
          <option value="Brun">Brun</option>
          <option value="Gris">Gris</option>
        </select>

        <label for="cre_sous_famille">Sous-famille</label>
        <input id="cre_sous_famille" placeholder="ex : COMBIN√â R√âFRIG√âRATEUR / CONG√âLATEUR" />

        <label for="cre_modele">Mod√®le</label>
        <input id="cre_modele" placeholder="ex : WTE6511B0" />

        <label for="cre_poids">Poids (kg)</label>
        <input id="cre_poids" type="number" step="0.1" />

        <button class="secondary btn-block" id="btn_valider_cre_manuel">
          ‚úÖ Valider (mode MANUEL ‚Äì d√©mo)
        </button>
      </div>

      <!-- Sous-formulaire AUTO (DPP / OCR ‚Äì mock) -->
      <div id="bloc_cre_auto" style="margin-top:0.6rem;display:none;">
        <h3>Mode AUTO (DPP / OCR)</h3>
        <p class="helper-text">
          Les champs ci-dessous sont remplis √† partir du DPP / de la photo. Tu peux corriger si besoin.
        </p>

        <label for="cre_ocr_flux">Flux</label>
        <input id="cre_ocr_flux" />

        <label for="cre_ocr_flux_sous">Sous-flux</label>
        <input id="cre_ocr_flux_sous" />

        <label for="cre_ocr_famille">Famille</label>
        <input id="cre_ocr_famille" />

        <label for="cre_ocr_sous_famille">Sous-famille</label>
        <input id="cre_ocr_sous_famille" />

        <label for="cre_ocr_marque">Marque</label>
        <input id="cre_ocr_marque" />

        <label for="cre_ocr_modele">Mod√®le</label>
        <input id="cre_ocr_modele" />

        <label for="cre_ocr_serie">N¬∞ de s√©rie</label>
        <input id="cre_ocr_serie" />

        <label for="cre_ocr_annee">Ann√©e</label>
        <input id="cre_ocr_annee" type="number" />

        <label for="cre_ocr_poids">Poids (kg)</label>
        <input id="cre_ocr_poids" type="number" step="0.1" />

        <button class="secondary btn-block" id="btn_valider_cre_auto">
          ‚úÖ Valider (mode AUTO ‚Äì d√©mo)
        </button>
      </div>

      <div id="cre_result" class="result" style="display:none;"></div>
    </div>

    <script>
      const API_BASE = "http://127.0.0.1:8000";
      let lastScan = null;

      let liveScanner = null;
      let liveScanActive = false;
      let liveScanMode = null; // "TRACA" ou "DPP"

      // --------- Helpers affichage ----------
      function showScanResult(text) {
        const div = document.getElementById("scan_result");
        div.style.display = "block";
        div.textContent = text;
      }

      function hideCreationCard() {
        document.getElementById("card_creation").style.display = "none";
        document.getElementById("bloc_cre_auto").style.display = "none";
        document.getElementById("bloc_cre_manuel").style.display = "none";
        document.getElementById("cre_result").style.display = "none";
      }

      function hideFicheDPP() {
        const card = document.getElementById("card_fiche_dpp");
        const div = document.getElementById("fiche_dpp");
        card.style.display = "none";
        div.textContent = "";
      }

      function showFicheDPP(info) {
        const card = document.getElementById("card_fiche_dpp");
        const div = document.getElementById("fiche_dpp");
        card.style.display = "block";

        const lignes = [];
        lignes.push("Fiche produit propos√©e √† partir du DPP / QR.");
        lignes.push("");
        lignes.push("Flux        : " + (info.flux || "-"));
        lignes.push("Sous-flux   : " + (info.flux_sous || "-"));
        lignes.push("Famille     : " + (info.famille || "-"));
        lignes.push("Sous-famille: " + (info.sous_famille || "-"));
        lignes.push(
          "Marque / Mod√®le : " +
            (info.marque || "-") +
            " / " +
            (info.modele || "-")
        );
        lignes.push("N¬∞ s√©rie    : " + (info.serie || "-"));
        lignes.push("Ann√©e       : " + (info.annee || "-"));
        lignes.push("Poids (kg)  : " + (info.poids_kg ?? "-"));
        lignes.push("");
        lignes.push("Texte brut DPP / QR :");
        lignes.push("----------------------------------------");
        lignes.push(info.brut || "-");

        div.textContent = lignes.join("\n");
        card.scrollIntoView({ behavior: "smooth" });
      }

      // --------- Interpr√©tation du contenu DPP ----------
      function parseDppFromRaw(raw) {
        const info = {
          flux: "",
          flux_sous: "",
          famille: "",
          sous_famille: "",
          marque: "",
          modele: "",
          serie: "",
          annee: "",
          poids_kg: "",
          brut: raw,
        };

        if (!raw) return info;
        const trimmed = raw.trim();

        // 1) Tentative JSON
        if (trimmed.startsWith("{") || trimmed.startsWith("[")) {
          try {
            const obj = JSON.parse(trimmed);
            const get = (...keys) => {
              for (const k of keys) {
                if (obj[k] != null) return String(obj[k]);
              }
              return "";
            };
            info.flux = get("flux", "flow", "flux_code");
            info.flux_sous = get("flux_sous", "subflow", "sub_flux", "flux_sub");
            info.famille = get("famille", "family", "category");
            info.sous_famille = get("sous_famille", "subcategory", "product_type");
            info.marque = get("marque", "brand", "manufacturer");
            info.modele = get("modele", "model", "product_model");
            info.serie = get("serie", "serial", "serial_number", "sn");
            info.annee = get("annee", "year", "manufacture_year");
            info.poids_kg = get("poids", "weight", "weight_kg");
            return info;
          } catch (e) {}
        }

        // 2) Tentative URL avec param√®tres
        try {
          const url = new URL(trimmed);
          const p = url.searchParams;
          const get = (...keys) => {
            for (const k of keys) {
              const v = p.get(k);
              if (v) return v;
            }
            return "";
          };
          info.flux = get("flux", "flow", "flux_code");
          info.flux_sous = get("flux_sous", "subflow", "sub_flux", "flux_sub");
          info.famille = get("famille", "family", "category");
          info.sous_famille = get("sous_famille", "subcategory", "product_type");
          info.marque = get("marque", "brand");
          info.modele = get("modele", "model");
          info.serie = get("serie", "serial", "sn");
          info.annee = get("annee", "year");
          info.poids_kg = get("poids", "weight", "weight_kg");
          return info;
        } catch (e) {}

        // 3) Sinon, tout reste vide, seul le brut est affich√©
        return info;
      }

      // --------- Base locale / droits ----------
      function renderProduitInfos(data) {
        const card = document.getElementById("card_produit");
        const div = document.getElementById("produit_infos");
        card.style.display = "block";

        hideCreationCard();

        if (!data.existe) {
          const peut = data.peut_creer_produit;
          const lignes = [];
          lignes.push("Produit INCONNU dans la base (ou erreur API).");
          lignes.push("");
          lignes.push("ID traca : " + (data.id_traca || "(non fourni)"));
          lignes.push(
            "Structure origine : " +
              (data.structure_origine?.code || "?") +
              " ‚Äì " +
              (data.structure_origine?.nom || "inconnue")
          );
          lignes.push(
            "Structure op√©rateur : " +
              (data.structure_operateur?.code || "?") +
              " ‚Äì " +
              (data.structure_operateur?.nom || "inconnue")
          );
          lignes.push("");

          if (peut) {
            lignes.push("‚úÖ Cr√©ation possible par cette structure.");
            document.getElementById("card_creation").style.display = "block";
          } else {
            lignes.push("‚õî Cr√©ation r√©serv√©e √† la structure d'origine.");
          }

          div.textContent = lignes.join("\n");
          return;
        }

        const p = data.produit;
        const droits = data.droits || {};
        const lignes = [];
        lignes.push("‚úÖ PRODUIT TROUV√â dans la base.");
        lignes.push("");
        lignes.push("ID traca : " + data.id_traca);
        lignes.push(
          "Structure origine  : " +
            (data.structure_origine.code || "?") +
            " ‚Äì " +
            (data.structure_origine.nom || "inconnue")
        );
        lignes.push(
          "Structure op√©rateur: " +
            (data.structure_operateur.code || "?") +
            " ‚Äì " +
            (data.structure_operateur.nom || "inconnue")
        );
        lignes.push("");
        lignes.push(
          "Flux / Famille / Sous-famille : " +
            (p.code_flux || "-") +
            " / " +
            (p.code_famille || "-") +
            " / " +
            (p.code_sous_famille || "-")
        );
        lignes.push(
          "Point de collecte : " +
            (p.point_collecte_code || "-") +
            " ‚Äì " +
            (p.point_collecte_libelle || "-")
        );
        lignes.push("Poids (kg)        : " + (p.poids_kg ?? "-"));
        lignes.push("√âtat actuel       : " + (p.etat || "-"));
        lignes.push("");
        lignes.push("Droits op√©rateur :");
        lignes.push(
          "- Modifier point collecte : " +
            (droits.peut_modifier_point_collecte ? "OUI" : "NON")
        );
        lignes.push(
          "- Modifier flux / famille : " +
            (droits.peut_modifier_flux_famille ? "OUI" : "NON")
        );
        lignes.push(
          "- Modifier √©tat          : " +
            (droits.peut_modifier_etat ? "OUI" : "NON")
        );

        div.textContent = lignes.join("\n");
      }

      async function doScan() {
        const id_traca = document.getElementById("scan_id_traca").value.trim();
        const struct_op = document.getElementById("scan_struct_op").value.trim();

        if (!id_traca) {
          showScanResult("‚ùå Scanner ou saisir l‚ÄôID Traca (12 chiffres).");
          document.getElementById("card_produit").style.display = "none";
          hideCreationCard();
          return;
        }

        if (id_traca.length < 4) {
          showScanResult("‚ùå ID Traca trop court.");
          document.getElementById("card_produit").style.display = "none";
          hideCreationCard();
          return;
        }

        showScanResult("‚è≥ Recherche dans la base Traca‚Ä¶");
        document.getElementById("card_produit").style.display = "none";
        hideCreationCard();

        try {
          const resp = await fetch(API_BASE + "/scan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id_traca: id_traca,
              code_structure_operateur: struct_op,
            }),
          });
          const data = await resp.json();

          if (!resp.ok) {
            // üëâ Cas erreur API : on passe quand m√™me en mode "produit inconnu mais cr√©able"
            lastScan = {
              existe: false,
              id_traca: id_traca,
              structure_origine: { code: "", nom: "" },
              structure_operateur: { code: struct_op, nom: "" },
              peut_creer_produit: true,
            };
            showScanResult(
              "‚ö†Ô∏è ID Traca non trouv√© ou format incorrect.\nJARVIS propose la cr√©ation du produit."
            );
            renderProduitInfos(lastScan);
            return;
          }

          lastScan = data;
          showScanResult(
            data.existe
              ? "‚úÖ Produit trouv√© dans la base."
              : data.peut_creer_produit
              ? "‚ÑπÔ∏è Produit inconnu, cr√©ation possible par la structure."
              : "‚ÑπÔ∏è Produit inconnu. Cr√©ation r√©serv√©e √† la structure d'origine."
          );
          renderProduitInfos(data);
        } catch (e) {
          // Erreur r√©seau : m√™me logique, on autorise une cr√©ation
          lastScan = {
            existe: false,
            id_traca: id_traca,
            structure_origine: { code: "", nom: "" },
            structure_operateur: { code: struct_op, nom: "" },
            peut_creer_produit: true,
          };
          showScanResult(
            "‚ö†Ô∏è Erreur de connexion.\nJARVIS propose la cr√©ation du produit (mode d√©grad√©)."
          );
          renderProduitInfos(lastScan);
        }
      }

      // ---------- Scan live cam√©ra (QR / code-barres) ----------
      function handleLiveScanResult(text) {
        if (!text) return;

        stopLiveScan(); // stop d√®s qu'il a lu quelque chose

        const trimmed = text.trim();
        const tracaRegex = /^\d{12}$/;

        if (liveScanMode === "TRACA") {
          if (tracaRegex.test(trimmed)) {
            document.getElementById("scan_id_traca").value = trimmed;
            showScanResult(
              "‚úÖ ID Traca d√©tect√© : " +
                trimmed +
                "\nCliquer sur ¬´ V√©rifier l‚ÄôID Traca ¬ª pour interroger la base."
            );
          } else {
            showScanResult(
              "‚ö†Ô∏è Code lu :\n" +
                trimmed +
                "\nCe code ne ressemble pas √† un ID Traca (12 chiffres)."
            );
          }
          return;
        }

        if (liveScanMode === "DPP") {
          // Entr√©e produit par DPP : on ne touche PAS √† l‚ÄôID Traca
          document.getElementById("scan_id_traca").value = "";

          // Interpr√©tation du DPP
          const dppInfo = parseDppFromRaw(trimmed);
          showFicheDPP(dppInfo);

          // Ouverture de la partie cr√©ation
          document.getElementById("card_creation").style.display = "block";
          ouvrirCreationAuto();

          document.getElementById("cre_ocr_flux").value = dppInfo.flux;
          document.getElementById("cre_ocr_flux_sous").value = dppInfo.flux_sous;
          document.getElementById("cre_ocr_famille").value = dppInfo.famille;
          document.getElementById("cre_ocr_sous_famille").value = dppInfo.sous_famille;
          document.getElementById("cre_ocr_marque").value = dppInfo.marque;
          document.getElementById("cre_ocr_modele").value = dppInfo.modele;
          document.getElementById("cre_ocr_serie").value = dppInfo.serie;
          document.getElementById("cre_ocr_annee").value = dppInfo.annee;
          document.getElementById("cre_ocr_poids").value = dppInfo.poids_kg;

          document.getElementById("card_creation").scrollIntoView({ behavior: "smooth" });

          showScanResult(
            "‚úÖ QR DPP d√©tect√©.\nLa fiche produit a √©t√© remplie √† partir du DPP.\nL‚ÄôID Traca reste √† scanner ou saisir."
          );
        }
      }

      function startLiveScan(mode) {
        liveScanMode = mode;
        const container = document.getElementById("scan_live_container");
        const label = document.getElementById("scan_live_mode_label");
        container.style.display = "block";

        if (mode === "TRACA") {
          label.textContent = "Scanner le code-barres Traca.";
        } else if (mode === "DPP") {
          label.textContent = "Scanner le QR du passeport num√©rique (DPP).";
        }

        if (liveScanActive) return;

        if (!window.Html5Qrcode) {
          showScanResult(
            "‚ùå Librairie de scan non charg√©e. V√©rifier la connexion internet / le script html5-qrcode."
          );
          return;
        }

        liveScanner = new Html5Qrcode("scan_live_view");

        liveScanner
          .start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 230, height: 230 } },
            (decodedText, decodedResult) => {
              handleLiveScanResult(decodedText);
            },
            (errorMessage) => {}
          )
          .then(() => {
            liveScanActive = true;
            showScanResult(
              mode === "TRACA"
                ? "üé• Scan TRACA actif. Cadrez le code-barres."
                : "üé• Scan DPP actif. Cadrez le QR."
            );
          })
          .catch((err) => {
            showScanResult(
              "‚ùå Impossible d'acc√©der √† la cam√©ra.\nAutoriser la cam√©ra ou utiliser la fonction Photo."
            );
            container.style.display = "none";
          });
      }

      function stopLiveScan() {
        if (liveScanner && liveScanActive) {
          liveScanner
            .stop()
            .then(() => {
              liveScanner.clear();
              liveScanActive = false;
              liveScanMode = null;
              document.getElementById("scan_live_container").style.display = "none";
            })
            .catch(() => {
              liveScanActive = false;
              liveScanMode = null;
              document.getElementById("scan_live_container").style.display = "none";
            });
        } else {
          liveScanActive = false;
          liveScanMode = null;
          document.getElementById("scan_live_container").style.display = "none";
        }
      }

      // ---------- Simulation Vision / DPP √† partir de la photo ----------
      function simulateVisionResult(file) {
        const name = (file.name || "").toLowerCase();

        if (name.includes("dpp") || name.includes("qr")) {
          // Simule un contenu DPP JSON pour d√©mo
          const raw =
            '{"flux":"GEMF","flux_sous":"GEMHF","famille":"R√©frig√©rateur / Cong√©lateur","sous_famille":"COMBIN√â R√âFRIG√âRATEUR / CONG√âLATEUR","marque":"SAMSUNG","modele":"RB31FEJNDSA/EF","serie":"SN-DPP-123456789","annee":2018,"poids":65}';
          return {
            type: "DPP_QR",
            raw: raw,
          };
        }

        return {
          type: "TRACA_BARCODE",
          id_traca: "170100000001",
          code_structure_operateur: "1701",
        };
      }

      function handlePhotoSelected(evt) {
        const file = evt.target.files[0];
        if (!file) return;

        showScanResult("üì§ Photo re√ßue. Analyse en cours (d√©mo)...");
        document.getElementById("card_produit").style.display = "none";
        hideCreationCard();
        hideFicheDPP();

        setTimeout(() => {
          const res = simulateVisionResult(file);

          if (res.type === "TRACA_BARCODE") {
            document.getElementById("scan_id_traca").value = res.id_traca;
            if (res.code_structure_operateur) {
              document.getElementById("scan_struct_op").value = res.code_structure_operateur;
            }
            showScanResult(
              "‚úÖ Code-barres Traca d√©tect√© √† partir de la photo.\nCliquer sur ¬´ V√©rifier l‚ÄôID Traca ¬ª."
            );
          } else if (res.type === "DPP_QR") {
            document.getElementById("scan_id_traca").value = "";

            const info = parseDppFromRaw(res.raw);
            showFicheDPP(info);

            document.getElementById("card_creation").style.display = "block";
            ouvrirCreationAuto();
            document.getElementById("cre_ocr_flux").value = info.flux || "";
            document.getElementById("cre_ocr_flux_sous").value = info.flux_sous || "";
            document.getElementById("cre_ocr_famille").value = info.famille || "";
            document.getElementById("cre_ocr_sous_famille").value = info.sous_famille || "";
            document.getElementById("cre_ocr_marque").value = info.marque || "";
            document.getElementById("cre_ocr_modele").value = info.modele || "";
            document.getElementById("cre_ocr_serie").value = info.serie || "";
            document.getElementById("cre_ocr_annee").value = info.annee || "";
            document.getElementById("cre_ocr_poids").value = info.poids_kg ?? "";

            document.getElementById("card_creation").scrollIntoView({ behavior: "smooth" });

            showScanResult(
              "‚úÖ DPP d√©tect√© √† partir de la photo.\nLa fiche produit est remplie √† partir du JSON simul√©."
            );
          }
        }, 700);
      }

      function openPhotoPicker() {
        document.getElementById("photo_input").click();
      }

      // --------- Cr√©ation AUTO / MANUELLE (mock) ----------
      function ouvrirCreationAuto() {
        const bloc = document.getElementById("bloc_cre_auto");
        const blocManuel = document.getElementById("bloc_cre_manuel");
        bloc.style.display = "block";
        blocManuel.style.display = "none";
        const div = document.getElementById("cre_result");
        div.style.display = "none";
        div.textContent = "";
      }

      function ouvrirCreationManuelle() {
        const bloc = document.getElementById("bloc_cre_manuel");
        const blocAuto = document.getElementById("bloc_cre_auto");
        bloc.style.display = "block";
        blocAuto.style.display = "none";
        const div = document.getElementById("cre_result");
        div.style.display = "none";
        div.textContent = "";
      }

      function mockCreationAuto() {
        const div = document.getElementById("cre_result");
        div.style.display = "block";

        const idTraca = document.getElementById("scan_id_traca").value.trim();
        if (!idTraca) {
          div.textContent = "‚ùå Scanner ou saisir un ID Traca avant de valider (AUTO).";
          return;
        }

        const pcCode = document.getElementById("cre_point_code").value.trim();
        const pcLib = document.getElementById("cre_point_lib").value.trim();
        if (!pcCode || !pcLib) {
          div.textContent = "‚ùå Renseigner le point de collecte (code + nom).";
          return;
        }

        const flux =
          document.getElementById("cre_ocr_flux").value.trim() || "(flux AUTO simul√©)";
        const fluxSous =
          document.getElementById("cre_ocr_flux_sous").value.trim() ||
          "(sous-flux AUTO simul√©)";
        const famille =
          document.getElementById("cre_ocr_famille").value.trim() || "(famille AUTO simul√©e)";
        const sousFamille =
          document.getElementById("cre_ocr_sous_famille").value.trim() ||
          "(sous-famille AUTO simul√©e)";
        const marque =
          document.getElementById("cre_ocr_marque").value.trim() || "(marque AUTO simul√©e)";
        const modele =
          document.getElementById("cre_ocr_modele").value.trim() || "(mod√®le AUTO simul√©)";
        const serie =
          document.getElementById("cre_ocr_serie").value.trim() || "(s√©rie AUTO simul√©e)";
        const annee =
          document.getElementById("cre_ocr_annee").value.trim() || "(ann√©e AUTO simul√©e)";
        const poids =
          document.getElementById("cre_ocr_poids").value.trim() || "(poids AUTO simul√©)";

        const lignes = [];
        lignes.push("‚úÖ Cr√©ation AUTO (d√©mo) ‚Äì donn√©es pr√™tes √† envoyer √† l‚ÄôAPI.");
        lignes.push("");
        lignes.push("ID Traca          : " + idTraca);
        lignes.push("Point de collecte : " + pcCode + " ‚Äì " + pcLib);
        lignes.push("Flux / Sous-flux  : " + flux + " / " + fluxSous);
        lignes.push("Famille / Sous-fam: " + famille + " / " + sousFamille);
        lignes.push("Marque / Mod√®le   : " + marque + " / " + modele);
        lignes.push("S√©rie / Ann√©e     : " + serie + " / " + annee);
        lignes.push("Poids (kg)        : " + poids);

        div.textContent = lignes.join("\n");
      }

      function mockCreationManuelle() {
        const div = document.getElementById("cre_result");
        div.style.display = "block";

        const idTraca = document.getElementById("scan_id_traca").value.trim();
        if (!idTraca) {
          div.textContent = "‚ùå Scanner ou saisir un ID Traca avant de valider (MANUEL).";
          return;
        }

        const pcCode = document.getElementById("cre_point_code").value.trim();
        const pcLib = document.getElementById("cre_point_lib").value.trim();
        if (!pcCode || !pcLib) {
          div.textContent = "‚ùå Renseigner le point de collecte (code + nom).";
          return;
        }

        const flux = document.getElementById("cre_flux").value.trim() || "(flux manuel)";
        const fluxSous =
          document.getElementById("cre_flux_sous").value.trim() ||
          "(sous-flux manuel)";
        const famille =
          document.getElementById("cre_famille").value.trim() || "(famille manuelle)";
        const sousFamille =
          document.getElementById("cre_sous_famille").value.trim() ||
          "(sous-famille manuelle)";
        const modele = document.getElementById("cre_modele").value.trim() || "(mod√®le manuel)";
        const poids = document.getElementById("cre_poids").value.trim() || "(poids manuel)";

        const lignes = [];
        lignes.push("‚úÖ Cr√©ation MANUELLE (d√©mo) ‚Äì donn√©es pr√™tes √† envoyer √† l‚ÄôAPI.");
        lignes.push("");
        lignes.push("ID Traca          : " + idTraca);
        lignes.push("Point de collecte : " + pcCode + " ‚Äì " + pcLib);
        lignes.push("Flux / Sous-flux  : " + flux + " / " + fluxSous);
        lignes.push("Famille / Sous-fam: " + famille + " / " + sousFamille);
        lignes.push("Mod√®le            : " + modele);
        lignes.push("Poids (kg)        : " + poids);

        div.textContent = lignes.join("\n");
      }

      // Bind des √©v√©nements
      document.getElementById("btn_scan").addEventListener("click", doScan);
      document.getElementById("btn_cre_auto").addEventListener("click", ouvrirCreationAuto);
      document.getElementById("btn_cre_manuel").addEventListener("click", ouvrirCreationManuelle);
      document
        .getElementById("btn_valider_cre_auto")
        .addEventListener("click", mockCreationAuto);
      document
        .getElementById("btn_valider_cre_manuel")
        .addEventListener("click", mockCreationManuelle);
      document.getElementById("btn_photo").addEventListener("click", openPhotoPicker);
      document
        .getElementById("photo_input")
        .addEventListener("change", handlePhotoSelected);
      document
        .getElementById("btn_live_scan_traca")
        .addEventListener("click", () => startLiveScan("TRACA"));
      document
        .getElementById("btn_live_scan_dpp")
        .addEventListener("click", () => startLiveScan("DPP"));
      document
        .getElementById("btn_live_scan_stop")
        .addEventListener("click", stopLiveScan);
    </script>
  </body>
</html>
