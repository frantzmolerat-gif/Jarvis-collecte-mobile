<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Jarvis Envie ‚Äì Collecte produit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Librairie de scan QR / code-barres -->
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
      :root {
        --envie-vert-fonce: #00463c;
        --envie-vert-moyen: #237031;
        --envie-vert-clair: #c7e1bc;
        --envie-orange: #ea5c10;

        --bg-page: #f4f5f7;
        --bg-card: #ffffff;
        --border-soft: #d0d4da;
        --text-main: #1f2933;
        --text-muted: #4b5563;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 0.8rem;
        background: var(--bg-page);
        color: var(--text-main);
      }

      .topbar {
        background: var(--envie-vert-fonce);
        color: #ffffff;
        padding: 0.6rem 0.8rem;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.18);
        margin-bottom: 0.8rem;
      }

      .topbar-main {
        display: flex;
        flex-direction: column;
      }

      .topbar-title {
        font-weight: 650;
        font-size: 1rem;
        letter-spacing: 0.02em;
      }

      .topbar-subtitle {
        font-size: 0.75rem;
        opacity: 0.9;
      }

      .topbar-badge {
        background: var(--envie-orange);
        color: #ffffff;
        font-size: 0.7rem;
        font-weight: 600;
        border-radius: 999px;
        padding: 0.25rem 0.6rem;
        white-space: nowrap;
      }

      h1 {
        margin: 0.4rem 0 0.2rem;
        font-size: 1rem;
        color: var(--envie-vert-fonce);
      }

      p.lead {
        font-size: 0.8rem;
        margin: 0 0 0.7rem;
        color: var(--text-muted);
      }

      .card {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 0.8rem;
        margin-bottom: 0.8rem;
        box-shadow: 0 2px 7px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(0, 0, 0, 0.03);
      }

      h2 {
        font-size: 0.95rem;
        margin: 0 0 0.4rem;
        color: var(--envie-vert-fonce);
      }

      label {
        display: block;
        font-size: 0.8rem;
        margin-top: 0.4rem;
        color: var(--text-main);
      }

      input,
      select {
        width: 100%;
        padding: 0.4rem 0.5rem;
        margin-top: 0.2rem;
        border-radius: 8px;
        border: 1px solid var(--border-soft);
        font-size: 0.85rem;
        background: #ffffff;
      }

      input:focus,
      select:focus {
        outline: 2px solid var(--envie-vert-moyen);
        outline-offset: 1px;
        border-color: var(--envie-vert-moyen);
      }

      button {
        margin-top: 0.6rem;
        padding: 0.5rem 0.8rem;
        border-radius: 999px;
        border: none;
        font-size: 0.9rem;
        cursor: pointer;
        background: var(--envie-vert-moyen);
        color: #ffffff;
        font-weight: 550;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
      }

      button.secondary {
        background: transparent;
        color: var(--envie-vert-fonce);
        border: 1px solid var(--envie-vert-fonce);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-block {
        width: 100%;
        justify-content: center;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.6rem;
      }

      .row-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.4rem;
        flex-wrap: wrap;
      }

      .result {
        margin-top: 0.5rem;
        padding: 0.5rem 0.6rem;
        font-size: 0.8rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        white-space: pre-wrap;
        color: #1f2933;
      }

      .helper-text {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.2rem;
      }

      .tournee-label,
      .collecte-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--envie-vert-fonce);
        margin-top: 0.3rem;
      }

      /* Overlay scanner */
      #scan_traca_modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      #scan_traca_modal_inner {
        background: #000;
        border-radius: 12px;
        padding: 0.5rem;
        max-width: 480px;
        width: 100%;
        margin: 0 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }

      #traca_reader {
        width: 100%;
      }

      #scan_traca_close {
        align-self: flex-end;
        background: #ffffff;
        color: #000;
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        border: none;
        font-size: 0.8rem;
        cursor: pointer;
      }

      #scan_traca_info {
        color: #ffffff;
        font-size: 0.75rem;
      }

      @media (max-width: 700px) {
        .row {
          grid-template-columns: 1fr;
        }

        .topbar {
          flex-direction: column;
          align-items: flex-start;
        }

        button.btn-block {
          width: 100%;
        }

        .row-buttons button {
          flex: 1 1 auto;
        }
      }

      @media (min-width: 1000px) {
        body {
          max-width: 900px;
          margin: 0 auto;
          padding: 1rem 0;
        }
      }
    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="topbar-main">
        <div class="topbar-title">JARVIS ¬∑ Envie</div>
        <div class="topbar-subtitle">Phase 1 ‚Äì Collecte & cr√©ation produit</div>
      </div>
      <div class="topbar-badge">L‚ÄôIA au service de l‚Äôinsertion</div>
    </header>

    <h1>Collecte produit ‚Äì Page 1</h1>
    <p class="lead">
      1. D√©marrer la tourn√©e<br />
      2. Choisir le <strong>point de collecte</strong><br />
      3. Saisir ou scanner l‚ÄôID Traca<br />
      4. Cr√©er la fiche si besoin
    </p>

    <!-- 0. Structure & tourn√©e -->
    <div class="card">
      <h2>0. Structure & tourn√©e du jour</h2>
      <div class="row">
        <div>
          <label for="scan_struct_op">Structure Envie op√©ratrice</label>
          <select id="scan_struct_op">
            <option value="1701">1701 ‚Äì Envie Dr√¥me Ard√®che</option>
            <option value="1001">1001 ‚Äì Envie Tourcoing</option>
            <option value="2101">2101 ‚Äì Envie Amiens</option>
          </select>
        </div>
        <div style="display:flex;flex-direction:column;justify-content:flex-end;">
          <button id="btn_tournee" type="button">üöö D√©marrer la tourn√©e</button>
        </div>
      </div>
      <div id="tournee_label" class="tournee-label">
        Tourn√©e du jour : (non d√©marr√©e)
      </div>
      <p class="helper-text">
        Une tourn√©e par structure et par jour sur ce t√©l√©phone. Le bouton est
        d√©sactiv√© apr√®s d√©marrage.
      </p>
    </div>

    <!-- 1. Point de collecte -->
    <div class="card">
      <h2>1. Point de collecte</h2>
      <label for="point_collecte_select">Point de collecte</label>
      <select id="point_collecte_select">
        <option value="">-- choisir le point de collecte --</option>
        <option value="DV26" data-libelle="Darty Valence">DV26 ‚Äì Darty Valence</option>
        <option value="AUTRE" data-libelle="Autre point (d√©mo)">
          AUTRE ‚Äì Autre point (d√©mo)
        </option>
      </select>
      <div id="collecte_label" class="collecte-label">
        Collecte en cours : (aucune)
      </div>
      <p class="helper-text">
        Chaque changement de point d√©marre une nouvelle collecte dans la tourn√©e.
      </p>
    </div>

    <!-- 2. ID Traca & Scan -->
    <div class="card">
      <h2>2. ID Traca</h2>
      <label for="scan_id_traca">ID Traca (12 chiffres ou derniers digits)</label>
      <input id="scan_id_traca" placeholder="ex : 210100001234 ou 1234" />
      <div class="helper-text">
        Saisie possible : 12 chiffres complets ou seulement les derniers (Jarvis
        reconstruit avec le code structure).
      </div>

      <div class="row-buttons">
        <button id="btn_scan" type="button">‚úÖ V√©rifier (saisie)</button>
        <button id="btn_scan_traca_live" class="secondary" type="button">
          üì∑ Scanner le code Traca
        </button>
      </div>

      <div id="scan_result" class="result" style="display:none;"></div>
    </div>

    <!-- 3. R√©sultat base -->
    <div class="card" id="card_produit" style="display:none;">
      <h2>3. R√©sultat base Jarvis/Tra√ßa</h2>
      <div id="produit_infos" class="result"></div>
    </div>

    <!-- 4. Cr√©ation produit -->
    <div class="card" id="card_creation" style="display:none;">
      <h2>4. Cr√©ation produit pour la collecte</h2>
      <p class="helper-text">
        Produit inconnu : la structure peut cr√©er une fiche minimale de collecte.
      </p>

      <div class="row">
        <div>
          <label for="cre_point_code">Point de collecte (code)</label>
          <input id="cre_point_code" placeholder="ex : DV26" />
        </div>
        <div>
          <label for="cre_point_lib">Point de collecte (nom)</label>
          <input id="cre_point_lib" placeholder="ex : Darty Valence" />
        </div>
      </div>

      <label for="cre_flux">Flux (ex : GEMF)</label>
      <input id="cre_flux" placeholder="ex : GEMF" />

      <label for="cre_famille">Famille</label>
      <input id="cre_famille" placeholder="ex : FROID" />

      <label for="cre_sous_famille">Sous-famille</label>
      <input
        id="cre_sous_famille"
        placeholder="ex : COMBIN√â R√âFRIG√âRATEUR / CONG√âLATEUR"
      />

      <label for="cre_marque">Marque</label>
      <input id="cre_marque" placeholder="ex : SAMSUNG" />

      <label for="cre_modele">Mod√®le</label>
      <input id="cre_modele" placeholder="ex : RB31FEJNDSA/EF" />

      <label for="cre_serie">N¬∞ de s√©rie</label>
      <input id="cre_serie" placeholder="ex : SN123456789" />

      <label for="cre_annee">Ann√©e de fabrication</label>
      <input id="cre_annee" type="number" placeholder="ex : 2018" />

      <label for="cre_poids">Poids (kg)</label>
      <input id="cre_poids" type="number" step="0.1" placeholder="ex : 65" />

      <button id="btn_creer" class="btn-block" type="button">
        ‚úÖ Cr√©er le produit (collecte)
      </button>

      <div id="cre_result" class="result" style="display:none;"></div>
    </div>

    <!-- Overlay scanner Traca -->
    <div id="scan_traca_modal">
      <div id="scan_traca_modal_inner">
        <button id="scan_traca_close">Fermer</button>
        <div id="scan_traca_info">
          üì∑ Pointez le code-barres ou QR contenant le num√©ro Traca.
        </div>
        <div id="traca_reader"></div>
      </div>
    </div>

    <script>
      // === CONFIG BACKEND ===
      const API_BASE = "https://jarvis-envie.onrender.com";

      // === √âTAT GLOBAL SIMPLE (pour toi) ===
      let currentTourneeNumero = null;
      let currentCollecteIndex = 0;
      let currentCollectePointCode = null;
      let tracaScanner = null; // html5-qrcode scanner

      // ---------- TOURN√âE (localStorage, simple) ----------
      function getTourneeStorageKey(struct_code) {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        const dateKey = `${yyyy}${mm}${dd}`;
        return `tournee_${struct_code}_${dateKey}`;
      }

      function loadTourneeState() {
        const struct_op = document.getElementById("scan_struct_op").value.trim();
        const label = document.getElementById("tournee_label");
        const btn = document.getElementById("btn_tournee");

        if (!struct_op) {
          label.textContent = "Tourn√©e du jour : (structure non renseign√©e)";
          btn.disabled = true;
          currentTourneeNumero = null;
          return;
        }

        const key = getTourneeStorageKey(struct_op);
        const stored = localStorage.getItem(key);

        if (stored) {
          label.textContent = "Tourn√©e du jour : " + stored;
          btn.textContent = "üöö Tourn√©e en cours";
          btn.disabled = true;
          currentTourneeNumero = stored;
        } else {
          label.textContent = "Tourn√©e du jour : (non d√©marr√©e)";
          btn.textContent = "üöö D√©marrer la tourn√©e";
          btn.disabled = false;
          currentTourneeNumero = null;
        }

        // reset collecte
        currentCollecteIndex = 0;
        currentCollectePointCode = null;
        updateCollecteLabel();
      }

      function startTournee() {
        const struct_op = document.getElementById("scan_struct_op").value.trim();
        const label = document.getElementById("tournee_label");
        const btn = document.getElementById("btn_tournee");

        if (!struct_op) {
          label.textContent = "Tourn√©e du jour : (structure non renseign√©e)";
          return;
        }

        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        const dateKey = `${yyyy}${mm}${dd}`;

        // simple : 001 pour la journ√©e
        const numero = `T-${struct_op}-${dateKey}-001`;
        const key = getTourneeStorageKey(struct_op);
        localStorage.setItem(key, numero);

        label.textContent = "Tourn√©e du jour : " + numero;
        btn.textContent = "üöö Tourn√©e en cours";
        btn.disabled = true;
        currentTourneeNumero = numero;

        // reset collecte
        currentCollecteIndex = 0;
        currentCollectePointCode = null;
        updateCollecteLabel();
      }

      document
        .getElementById("scan_struct_op")
        .addEventListener("change", loadTourneeState);
      document.getElementById("btn_tournee").addEventListener("click", startTournee);

      // ---------- COLLECTE (simple, c√¥t√© front) ----------
      function getPointCollecte() {
        const sel = document.getElementById("point_collecte_select");
        const val = sel.value;
        if (!val) return null;
        const opt = sel.options[sel.selectedIndex];
        const lib = opt.getAttribute("data-libelle") || opt.textContent.trim();
        return { code: val, libelle: lib };
      }

      function updateCollecteLabel() {
        const label = document.getElementById("collecte_label");
        const pc = getPointCollecte();
        if (!currentTourneeNumero) {
          label.textContent =
            "Collecte en cours : (d√©marrer la tourn√©e avant de collecter)";
          return;
        }
        if (!pc) {
          label.textContent = "Collecte en cours : (aucune ‚Äì choisir un point)";
          return;
        }
        if (!currentCollecteIndex) {
          label.textContent =
            "Collecte en cours : (en attente ‚Äì valider le point de collecte)";
          return;
        }
        const numCollecte = `C-${currentTourneeNumero}-${String(
          currentCollecteIndex
        ).padStart(3, "0")}`;
        label.textContent =
          "Collecte en cours : " +
          numCollecte +
          " ‚Äì " +
          pc.code +
          " ‚Äì " +
          pc.libelle;
      }

      function onPointCollecteChange() {
        const pc = getPointCollecte();
        if (!currentTourneeNumero || !pc) {
          currentCollecteIndex = 0;
          currentCollectePointCode = null;
          updateCollecteLabel();
          return;
        }
        // changement de point => nouvelle collecte
        if (pc.code !== currentCollectePointCode) {
          currentCollecteIndex += 1;
          currentCollectePointCode = pc.code;
        }
        updateCollecteLabel();
        // synchro dans le formulaire de cr√©ation
        syncPointCollecteToCreation();
      }

      document
        .getElementById("point_collecte_select")
        .addEventListener("change", onPointCollecteChange);

      function syncPointCollecteToCreation() {
        const pc = getPointCollecte();
        const codeInput = document.getElementById("cre_point_code");
        const libInput = document.getElementById("cre_point_lib");
        if (!pc) {
          codeInput.value = "";
          libInput.value = "";
          return;
        }
        codeInput.value = pc.code;
        libInput.value = pc.libelle;
      }

      // ---------- AFFICHAGE / RESULTATS ----------
      function showScanResult(text) {
        const div = document.getElementById("scan_result");
        div.style.display = "block";
        div.textContent = text;
      }

      function renderProduitInfos(data) {
        const card = document.getElementById("card_produit");
        const div = document.getElementById("produit_infos");
        card.style.display = "block";

        const pc = getPointCollecte();
        const lignes = [];

        if (data.existe && data.produit) {
          const p = data.produit;
          lignes.push("‚úÖ PRODUIT TROUV√â dans la base.");
          lignes.push("");
          lignes.push("ID Traca : " + data.id_traca);
          lignes.push(
            "Structure origine : " +
              (data.structure_origine.code || "?") +
              " ‚Äì " +
              (data.structure_origine.nom || "inconnue")
          );
          lignes.push(
            "Structure op√©rateur : " +
              (data.structure_operateur.code || "?") +
              " ‚Äì " +
              (data.structure_operateur.nom || "inconnue")
          );
          if (pc) {
            lignes.push(
              "Point de collecte (s√©lectionn√©) : " +
                pc.code +
                " ‚Äì " +
                pc.libelle
            );
          }
          lignes.push("");
          lignes.push(
            "Flux / Famille / Sous-famille : " +
              (p.code_flux || "-") +
              " / " +
              (p.code_famille || "-") +
              " / " +
              (p.code_sous_famille || "-")
          );
          lignes.push(
            "Point de collecte enregistr√© : " +
              (p.point_collecte_code || "-") +
              " ‚Äì " +
              (p.point_collecte_libelle || "-")
          );
          lignes.push("Poids (kg)        : " + (p.poids_kg ?? "-"));
          lignes.push("√âtat              : " + (p.etat || "-"));
        } else {
          lignes.push("‚ÑπÔ∏è Produit inconnu dans la base.");
          lignes.push("");
          lignes.push("ID Traca : " + data.id_traca);
          lignes.push(
            "Structure op√©rateur : " +
              (data.structure_operateur.code || "?") +
              " ‚Äì " +
              (data.structure_operateur.nom || "inconnue")
          );
          if (pc) {
            lignes.push(
              "Point de collecte (s√©lectionn√©) : " +
                pc.code +
                " ‚Äì " +
                pc.libelle
            );
          }
          lignes.push("");
          if (data.peut_creer_produit) {
            lignes.push("‚úÖ Cr√©ation autoris√©e pour cette structure.");
            document.getElementById("card_creation").style.display = "block";
            syncPointCollecteToCreation();
          } else {
            lignes.push("‚õî Cr√©ation r√©serv√©e √† la structure d'origine.");
            document.getElementById("card_creation").style.display = "none";
          }
        }

        div.textContent = lignes.join("\n");
      }

      // ---------- SCAN ID (saisie manuelle ou derniers digits) ----------
      async function doScan() {
        const pc = getPointCollecte();
        if (!pc) {
          showScanResult("‚ùå Choisir d‚Äôabord le point de collecte.");
          document.getElementById("card_produit").style.display = "none";
          document.getElementById("card_creation").style.display = "none";
          return;
        }

        let saisie = document.getElementById("scan_id_traca").value.trim();
        const struct_op = document.getElementById("scan_struct_op").value.trim();

        if (!saisie) {
          showScanResult(
            "‚ùå Saisir l‚ÄôID Traca (12 chiffres ou seulement les derniers)."
          );
          document.getElementById("card_produit").style.display = "none";
          document.getElementById("card_creation").style.display = "none";
          return;
        }

        if (!/^\d+$/.test(saisie)) {
          showScanResult("‚ùå L‚ÄôID Traca doit contenir uniquement des chiffres.");
          document.getElementById("card_produit").style.display = "none";
          document.getElementById("card_creation").style.display = "none";
          return;
        }

        let id_traca_final = saisie;
        if (saisie.length < 12) {
          if (!/^\d{4}$/.test(struct_op)) {
            showScanResult(
              "‚ùå Pour saisir uniquement les derniers digits, la structure doit √™tre un code √† 4 chiffres (ex : 2101)."
            );
            document.getElementById("card_produit").style.display = "none";
            document.getElementById("card_creation").style.display = "none";
            return;
          }
          const prefix = struct_op;
          const totalLen = 12;
          const suffixLen = totalLen - prefix.length;
          const suffix = saisie.padStart(suffixLen, "0");
          id_traca_final = prefix + suffix;
        }

        showScanResult(
          "‚è≥ V√©rification dans la base‚Ä¶\nID utilis√© : " +
            id_traca_final +
            "\nPoint de collecte : " +
            pc.code +
            " ‚Äì " +
            pc.libelle
        );
        document.getElementById("card_produit").style.display = "none";
        document.getElementById("card_creation").style.display = "none";

        try {
          const resp = await fetch(API_BASE + "/scan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id_traca: id_traca_final,
              code_structure_operateur: struct_op,
            }),
          });
          const data = await resp.json();
          if (!resp.ok) {
            showScanResult("‚ùå Erreur API /scan : " + (data.detail || resp.status));
            return;
          }
          showScanResult(data.message || "OK.");
          renderProduitInfos(data);
        } catch (e) {
          showScanResult("‚ùå Erreur de connexion au backend : " + e);
        }
      }

      document.getElementById("btn_scan").addEventListener("click", doScan);

      // ---------- SCAN LIVE (vrai scan cam√©ra) ----------
      function openTracaScanner() {
        const modal = document.getElementById("scan_traca_modal");
        const info = document.getElementById("scan_traca_info");
        modal.style.display = "flex";
        info.textContent =
          "üì∑ Pointez le code-barres / QR contenant le num√©ro Traca. La lecture est automatique.";

        // On d√©truit un scanner pr√©c√©dent s'il existe
        if (tracaScanner) {
          tracaScanner
            .clear()
            .catch(() => {})
            .finally(() => {
              tracaScanner = null;
              startNewScanner();
            });
        } else {
          startNewScanner();
        }

        function startNewScanner() {
          const onScanSuccess = (decodedText, decodedResult) => {
            const txt = (decodedText || "").trim();
            // On attend un num√©ro Traca = chiffres uniquement
            if (!/^\d{1,20}$/.test(txt)) {
              info.textContent =
                "‚ö†Ô∏è Code lu : " +
                txt +
                " (non reconnu comme num√©ro Traca, viser le code-barres chiffr√©).";
              return; // continue de scanner
            }

            // On prend au max 12 chiffres (au cas o√π)
            let truncated = txt;
            if (txt.length > 12) {
              truncated = txt.slice(-12);
            }

            document.getElementById("scan_id_traca").value = truncated;
            info.textContent = "‚úÖ Code d√©tect√© : " + truncated;

            // Stopper le scanner et fermer l‚Äôoverlay
            if (tracaScanner) {
              tracaScanner
                .clear()
                .catch(() => {})
                .finally(() => {
                  tracaScanner = null;
                  modal.style.display = "none";
                  // On lance la v√©rification dans la base
                  doScan();
                });
            } else {
              modal.style.display = "none";
              doScan();
            }
          };

          const onScanFailure = (error) => {
            // erreurs de lecture fr√©quentes, on ignore
          };

          tracaScanner = new Html5QrcodeScanner(
            "traca_reader",
            { fps: 10, qrbox: { width: 250, height: 250 } },
            false
          );
          tracaScanner.render(onScanSuccess, onScanFailure);
        }
      }

      function closeTracaScanner() {
        const modal = document.getElementById("scan_traca_modal");
        if (tracaScanner) {
          tracaScanner
            .clear()
            .catch(() => {})
            .finally(() => {
              tracaScanner = null;
              modal.style.display = "none";
            });
        } else {
          modal.style.display = "none";
        }
      }

      document
        .getElementById("btn_scan_traca_live")
        .addEventListener("click", openTracaScanner);
      document
        .getElementById("scan_traca_close")
        .addEventListener("click", closeTracaScanner);

      // ---------- CR√âATION PRODUIT ----------
      async function doCreate() {
        const pc = getPointCollecte();
        const div = document.getElementById("cre_result");
        div.style.display = "block";

        if (!pc) {
          div.textContent = "‚ùå Choisir le point de collecte avant de cr√©er.";
          return;
        }

        const id_traca_saisi = document
          .getElementById("scan_id_traca")
          .value.trim();
        const struct_op = document.getElementById("scan_struct_op").value.trim();

        if (!struct_op) {
          div.textContent = "‚ùå Choisir la structure op√©ratrice.";
          return;
        }

        const pcCode = document.getElementById("cre_point_code").value.trim();
        const pcLib = document.getElementById("cre_point_lib").value.trim();
        if (!pcCode || !pcLib) {
          div.textContent =
            "‚ùå Merci de renseigner le point de collecte (code + libell√©).";
          return;
        }

        let id_traca_final = id_traca_saisi || null;
        if (id_traca_final && id_traca_final.length < 12) {
          const prefix = struct_op;
          const totalLen = 12;
          const suffixLen = totalLen - prefix.length;
          const suffix = id_traca_final.padStart(suffixLen, "0");
          id_traca_final = prefix + suffix;
        }

        const payload = {
          id_traca: id_traca_final,
          code_structure_operateur: struct_op,
          point_collecte_code: pcCode,
          point_collecte_libelle: pcLib,
          code_flux: document.getElementById("cre_flux").value.trim() || null,
          code_famille: document.getElementById("cre_famille").value.trim() || null,
          code_sous_famille:
            document.getElementById("cre_sous_famille").value.trim() || null,
          marque: document.getElementById("cre_marque").value.trim() || null,
          modele: document.getElementById("cre_modele").value.trim() || null,
          numero_serie: document.getElementById("cre_serie").value.trim() || null,
          annee_fabrication:
            document.getElementById("cre_annee").value.trim() || null,
          poids_kg: document.getElementById("cre_poids").value.trim() || null,
          brut_ocr: null,
          source_ocr: null,
        };

        if (payload.annee_fabrication !== null && payload.annee_fabrication !== "") {
          payload.annee_fabrication = parseInt(payload.annee_fabrication, 10);
        } else {
          payload.annee_fabrication = null;
        }
        if (payload.poids_kg !== null && payload.poids_kg !== "") {
          payload.poids_kg = parseFloat(payload.poids_kg);
        } else {
          payload.poids_kg = null;
        }

        div.textContent = "‚è≥ Cr√©ation du produit en cours‚Ä¶";

        try {
          const resp = await fetch(API_BASE + "/collecte/creer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await resp.json();
          if (!resp.ok) {
            div.textContent =
              "‚ùå Erreur API /collecte/creer : " + (data.detail || resp.status);
            return;
          }

          const p = data.produit || {};
          const lignes = [];
          lignes.push("‚úÖ Produit cr√©√© pour la collecte.");
          lignes.push("");
          lignes.push("ID Traca : " + (data.id_traca || p.id_traca || "?"));
          lignes.push(
            "Point de collecte : " +
              (p.point_collecte_code || pcCode) +
              " ‚Äì " +
              (p.point_collecte_libelle || pcLib)
          );
          lignes.push(
            "Flux / Famille / Sous-famille : " +
              (p.code_flux || payload.code_flux || "-") +
              " / " +
              (p.code_famille || payload.code_famille || "-") +
              " / " +
              (p.code_sous_famille || payload.code_sous_famille || "-")
          );
          lignes.push(
            "Marque / Mod√®le : " +
              (p.marque || payload.marque || "-") +
              " / " +
              (p.modele || payload.modele || "-")
          );
          lignes.push(
            "Poids (kg) : " +
              (p.poids_kg != null ? p.poids_kg : payload.poids_kg ?? "-")
          );

          div.textContent = lignes.join("\n");
        } catch (e) {
          div.textContent = "‚ùå Erreur de connexion au backend : " + e;
        }
      }

      document.getElementById("btn_creer").addEventListener("click", doCreate);

      // ---------- INIT ----------
      window.addEventListener("load", loadTourneeState);
    </script>
  </body>
</html>
