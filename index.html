<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>JARVIS Envie ‚Äì Scan & Cr√©ation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        /* Palette officielle Envie */
        --envie-vert-fonce: #00463c;
        --envie-vert-moyen: #237031;
        --envie-vert-clair: #c7e1bc;
        --envie-orange: #ea5c10;

        --bg-page: #f4f5f7;
        --bg-card: #ffffff;
        --border-soft: #d0d4da;
        --text-main: #1f2933;
        --text-muted: #4b5563;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 1.5rem;
        background: var(--bg-page);
        color: var(--text-main);
      }

      /* Bandeau haut JARVIS / Envie */
      .topbar {
        background: var(--envie-vert-fonce);
        color: #ffffff;
        padding: 0.9rem 1.1rem;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.18);
        margin-bottom: 1.5rem;
      }

      .topbar-main {
        display: flex;
        flex-direction: column;
      }

      .topbar-title {
        font-weight: 650;
        font-size: 1.1rem;
        letter-spacing: 0.02em;
      }

      .topbar-subtitle {
        font-size: 0.8rem;
        opacity: 0.9;
      }

      .topbar-tag {
        font-size: 0.7rem;
        text-transform: uppercase;
        border-radius: 999px;
        padding: 0.2rem 0.6rem;
        border: 1px solid rgba(255, 255, 255, 0.5);
        opacity: 0.9;
      }

      .topbar-badge {
        background: var(--envie-orange);
        color: #ffffff;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 999px;
        padding: 0.3rem 0.75rem;
        white-space: nowrap;
      }

      h1 {
        margin: 0.75rem 0 0.25rem;
        font-size: 1.15rem;
        color: var(--envie-vert-fonce);
      }

      p.lead {
        font-size: 0.9rem;
        max-width: 800px;
        margin: 0 0 1rem;
        color: var(--text-muted);
      }

      .card {
        background: var(--bg-card);
        border-radius: 14px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.25rem;
        box-shadow: 0 2px 7px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(0, 0, 0, 0.03);
      }

      h2 {
        font-size: 1rem;
        margin-top: 0;
        margin-bottom: 0.4rem;
        color: var(--envie-vert-fonce);
      }

      h3 {
        font-size: 0.95rem;
        margin-bottom: 0.4rem;
        color: var(--envie-vert-moyen);
      }

      label {
        display: block;
        font-size: 0.85rem;
        margin-top: 0.6rem;
        color: var(--text-main);
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 0.45rem 0.55rem;
        margin-top: 0.2rem;
        border-radius: 8px;
        border: 1px solid var(--border-soft);
        font-size: 0.9rem;
        box-sizing: border-box;
        background: #ffffff;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: 2px solid var(--envie-vert-moyen);
        outline-offset: 1px;
        border-color: var(--envie-vert-moyen);
      }

      textarea {
        resize: vertical;
        min-height: 3rem;
      }

      button {
        margin-top: 0.8rem;
        padding: 0.55rem 1.1rem;
        border-radius: 999px;
        border: none;
        font-size: 0.9rem;
        cursor: pointer;
        background: var(--envie-vert-moyen);
        color: #ffffff;
        font-weight: 550;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
      }

      button.secondary {
        background: transparent;
        color: var(--envie-vert-fonce);
        border: 1px solid var(--envie-vert-fonce);
      }

      button.secondary:hover {
        background: var(--envie-vert-clair);
      }

      button.danger {
        background: #e53e3e;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
      }

      .result {
        margin-top: 0.7rem;
        padding: 0.6rem 0.7rem;
        font-size: 0.85rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        white-space: pre-wrap;
        color: #1f2933;
      }

      .pill {
        display: inline-block;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        font-size: 0.75rem;
        margin-right: 0.4rem;
        margin-top: 0.2rem;
        background: #e2f4ec;
        color: var(--envie-vert-fonce);
        border: 1px solid rgba(0, 0, 0, 0.05);
      }

      .pill.red {
        background: #fde2e2;
        color: #8b1f1f;
      }

      .pill.gray {
        background: #e2e8f0;
        color: #334155;
      }

      .pill.orange {
        background: #ffe7d5;
        color: var(--envie-orange);
      }

      .helper-text {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
      }

      /* Responsive mobile (collecteur) */
      @media (max-width: 700px) {
        body {
          padding: 1rem 0.8rem;
        }

        .row {
          grid-template-columns: 1fr;
        }

        .topbar {
          flex-direction: column;
          align-items: flex-start;
        }

        .topbar-badge {
          align-self: flex-start;
        }

        h1 {
          font-size: 1.1rem;
        }

        button {
          width: 100%;
        }
      }

      /* Confort back office (√©cran large) */
      @media (min-width: 1000px) {
        body {
          max-width: 1100px;
          margin: 0 auto;
          padding: 2rem 0;
        }

        .topbar {
          border-radius: 20px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Bandeau haut JARVIS / Envie -->
    <header class="topbar">
      <div class="topbar-main">
        <div class="topbar-title">JARVIS ¬∑ Envie</div>
        <div class="topbar-subtitle">
          Interface de tri & tra√ßabilit√© ‚Äì compatible collecte mobile et back office
        </div>
      </div>
      <div>
        <div class="topbar-tag">Prototype v1</div>
        <div class="topbar-badge">L‚ÄôIA au service de l‚Äôinsertion</div>
      </div>
    </header>

    <h1>Traca Envie ‚Äì Interface Scan & Cr√©ation</h1>
    <p class="lead">
      1Ô∏è‚É£ On commence toujours par <strong>l‚ÄôID Traca</strong> (scan ou saisie) et la
      <strong>structure op√©rateur</strong> (site qui scanne).<br />
      2Ô∏è‚É£ Le syst√®me indique si le produit existe d√©j√†, et si ta structure a le droit de le cr√©er.<br />
      3Ô∏è‚É£ Si la cr√©ation est possible, tu peux choisir entre <strong>mode AUTO (OCR)</strong> et
      <strong>mode MANUEL</strong>.
    </p>

    <!-- Carte 1 : SCAN -->
    <div class="card">
      <h2>1. Scan / saisie d‚Äôun ID Traca</h2>
      <div class="row">
        <div>
          <label for="scan_id_traca">ID Traca (12 chiffres)</label>
          <input id="scan_id_traca" placeholder="ex : 170100000001" />
          <div class="helper-text">
            Pour les tests : tu peux saisir un ID existant ou un ID factice pour simuler un produit inconnu.
          </div>
        </div>
        <div>
          <label for="scan_struct_op">Structure op√©rateur</label>
          <select id="scan_struct_op">
            <option value="1701">1701 ‚Äì Envie Dr√¥me Ard√®che</option>
            <option value="1001">1001 ‚Äì Envie Tourcoing</option>
          </select>
        </div>
      </div>
      <button id="btn_scan">üîç Analyser le num√©ro</button>
      <div id="scan_result" class="result" style="display:none;"></div>
    </div>

    <!-- Carte 2 : R√©sum√© produit -->
    <div class="card" id="card_produit" style="display:none;">
      <h2>2. R√©sultat (existence + droits)</h2>
      <div id="produit_infos" class="result"></div>
    </div>

    <!-- Carte 3 : Cr√©ation produit (si ID inconnu mais cr√©able par la structure) -->
    <div class="card" id="card_creation" style="display:none;">
      <h2>3. Cr√©ation de ce produit</h2>
      <p class="helper-text">
        L‚ÄôID traca n‚Äôexiste pas encore en base et ta structure est autoris√©e √† le cr√©er.<br />
        Choisis d‚Äôabord le <strong>point de collecte</strong>, puis le mode de cr√©ation.
      </p>

      <div class="row">
        <div>
          <label for="cre_point_code">Point de collecte (code interne, ex : PC01)</label>
          <input id="cre_point_code" />
        </div>
        <div>
          <label for="cre_point_lib">Libell√© point de collecte</label>
          <input id="cre_point_lib" placeholder="ex : Boulanger, D√©chetterie X‚Ä¶" />
        </div>
      </div>

      <h3 style="margin-top:1rem;">Mode de cr√©ation</h3>
      <p style="font-size:0.8rem;">
        <span class="pill orange">AUTO (OCR)</span>
        Utilise l‚ÄôIA/OCR pour proposer marque / mod√®le / s√©rie / √¢ge.<br />
        <span class="pill gray">MANUEL</span>
        Tu saisis famille, sous-famille, mod√®le, poids.
      </p>

      <div class="row">
        <div>
          <button class="secondary" id="btn_cre_auto">‚öôÔ∏è Cr√©ation automatique (OCR / mode hybride)</button>
        </div>
        <div>
          <button class="secondary" id="btn_cre_manuel">‚úçÔ∏è Cr√©ation manuelle</button>
        </div>
      </div>

      <!-- Sous-formulaire MANUEL -->
      <div id="bloc_cre_manuel" style="margin-top:1rem;display:none;">
        <h3>Cr√©ation MANUELLE</h3>
        <label for="cre_famille">Famille Envie</label>
        <select id="cre_famille">
          <option value="">-- choisir --</option>
          <option value="Froid">Froid</option>
          <option value="Lavage">Lavage</option>
          <option value="Cuisson">Cuisson</option>
          <option value="PEM">PEM</option>
          <option value="Brun">Brun</option>
          <option value="Gris">Gris</option>
        </select>

        <label for="cre_sous_famille">Sous-famille (libell√© Envie)</label>
        <input id="cre_sous_famille" placeholder="ex : r√©frig√©rateur am√©ricain, lave-linge hublot‚Ä¶" />

        <label for="cre_modele">Mod√®le (manuel ou sugg√©r√© plus tard via Odaia)</label>
        <input id="cre_modele" placeholder="ex : WTE6511B0" />

        <label for="cre_poids">Poids (kg)</label>
        <input id="cre_poids" type="number" step="0.1" />

        <button class="secondary" id="btn_valider_cre_manuel">
          ‚úÖ Valider la cr√©ation manuelle (mock)
        </button>
      </div>

      <!-- Sous-formulaire AUTO (OCR hybride) -->
      <div id="bloc_cre_auto" style="margin-top:1rem;display:none;">
        <h3>Cr√©ation AUTO (OCR ‚Äì mode hybride)</h3>
        <p class="helper-text">
          Ici, on simulera les donn√©es remont√©es par l‚ÄôOCR (avant branchement √† Odaia / Google Vision).<br />
          Plus tard : flux r√©el photo ‚Üí OCR ‚Üí JSON ‚Üí JARVIS.
        </p>
        <label for="cre_ocr_marque">Marque (propos√©e par OCR)</label>
        <input id="cre_ocr_marque" placeholder="ex : BEKO" />

        <label for="cre_ocr_modele">Mod√®le (propos√© par OCR)</label>
        <input id="cre_ocr_modele" placeholder="ex : WTE6511B0" />

        <label for="cre_ocr_serie">N¬∞ de s√©rie (propos√© par OCR)</label>
        <input id="cre_ocr_serie" placeholder="ex : 123456789" />

        <label for="cre_ocr_annee">Ann√©e (propos√©e par OCR)</label>
        <input id="cre_ocr_annee" type="number" />

        <button class="secondary" id="btn_valider_cre_auto">
          ‚úÖ Valider la cr√©ation AUTO (mock)
        </button>
      </div>

      <div id="cre_result" class="result" style="display:none;"></div>
    </div>

    <script>
      const API_BASE = "http://127.0.0.1:8000";
      let lastScan = null;

      function showScanResult(text) {
        const div = document.getElementById("scan_result");
        div.style.display = "block";
        div.textContent = text;
      }

      function hideCreationCard() {
        document.getElementById("card_creation").style.display = "none";
        document.getElementById("bloc_cre_auto").style.display = "none";
        document.getElementById("bloc_cre_manuel").style.display = "none";
        document.getElementById("cre_result").style.display = "none";
      }

      function renderProduitInfos(data) {
        const card = document.getElementById("card_produit");
        const div = document.getElementById("produit_infos");
        card.style.display = "block";

        hideCreationCard();

        if (!data.existe) {
          const peut = data.peut_creer_produit;
          const lignes = [];
          lignes.push("Produit INCONNU dans la base.");
          lignes.push("");
          lignes.push("ID traca : " + data.id_traca);
          lignes.push(
            "Structure d'origine : " +
              (data.structure_origine.code || "?") +
              " ‚Äì " +
              (data.structure_origine.nom || "inconnue")
          );
          lignes.push(
            "Structure op√©rateur : " +
              (data.structure_operateur.code || "?") +
              " ‚Äì " +
              (data.structure_operateur.nom || "inconnue")
          );
          lignes.push("");

          if (peut) {
            lignes.push("‚úÖ Cr√©ation possible par cette structure.");
            document.getElementById("card_creation").style.display = "block";
          } else {
            lignes.push("‚õî Cr√©ation r√©serv√©e √† la structure d'origine.");
          }

          div.textContent = lignes.join("\n");
          return;
        }

        const p = data.produit;
        const droits = data.droits || {};
        const lignes = [];
        lignes.push("‚úÖ PRODUIT TROUV√â");
        lignes.push("");
        lignes.push("ID traca : " + data.id_traca);
        lignes.push(
          "Structure origine  : " +
            (data.structure_origine.code || "?") +
            " ‚Äì " +
            (data.structure_origine.nom || "inconnue")
        );
        lignes.push(
          "Structure op√©rateur: " +
            (data.structure_operateur.code || "?") +
            " ‚Äì " +
            (data.structure_operateur.nom || "inconnue")
        );
        lignes.push("");
        lignes.push(
          "Flux / Famille / Sous-famille : " +
            (p.code_flux || "-") +
            " / " +
            (p.code_famille || "-") +
            " / " +
            (p.code_sous_famille || "-")
        );
        lignes.push(
          "Point de collecte : " +
            (p.point_collecte_code || "-") +
            " ‚Äì " +
            (p.point_collecte_libelle || "-")
        );
        lignes.push("Poids (kg)        : " + (p.poids_kg ?? "-"));
        lignes.push("√âtat actuel       : " + (p.etat || "-"));
        lignes.push("");
        lignes.push("Droits op√©rateur :");
        lignes.push(
          "- Modifier point de collecte : " +
            (droits.peut_modifier_point_collecte ? "OUI" : "NON")
        );
        lignes.push(
          "- Modifier flux / famille    : " +
            (droits.peut_modifier_flux_famille ? "OUI" : "NON")
        );
        lignes.push(
          "- Modifier √âTAT              : " +
            (droits.peut_modifier_etat ? "OUI" : "NON")
        );
        lignes.push(
          "- Modifier OCR               : " +
            (droits.peut_modifier_ocr ? "OUI" : "NON")
        );
        lignes.push(
          "- Modifier ORIENTATION       : " +
            (droits.peut_modifier_orientation ? "OUI" : "NON")
        );

        div.textContent = lignes.join("\n");
      }

      async function doScan() {
        const id_traca = document.getElementById("scan_id_traca").value.trim();
        const struct_op = document.getElementById("scan_struct_op").value.trim();

        if (!id_traca) {
          showScanResult("‚ùå Merci de saisir un ID traca (12 chiffres).");
          document.getElementById("card_produit").style.display = "none";
          hideCreationCard();
          return;
        }

        if (id_traca.length < 4) {
          showScanResult("‚ùå ID traca invalide (au moins 4 chiffres).");
          document.getElementById("card_produit").style.display = "none";
          hideCreationCard();
          return;
        }

        showScanResult("Analyse en cours‚Ä¶");
        document.getElementById("card_produit").style.display = "none";
        hideCreationCard();

        try {
          const resp = await fetch(API_BASE + "/scan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id_traca: id_traca,
              code_structure_operateur: struct_op,
            }),
          });
          const data = await resp.json();

          if (!resp.ok) {
            showScanResult("Erreur API : " + (data.detail || JSON.stringify(data)));
            document.getElementById("card_produit").style.display = "none";
            hideCreationCard();
            return;
          }

          lastScan = data;
          showScanResult(
            data.existe
              ? "‚úÖ Produit trouv√©. Voir les d√©tails ci-dessous."
              : data.peut_creer_produit
              ? "‚ÑπÔ∏è Produit inconnu, mais cr√©ation possible par cette structure."
              : "‚ÑπÔ∏è Produit inconnu. Cr√©ation r√©serv√©e √† la structure d'origine."
          );
          renderProduitInfos(data);
        } catch (e) {
          showScanResult("Erreur r√©seau ou serveur : " + e);
          document.getElementById("card_produit").style.display = "none";
          hideCreationCard();
        }
      }

      // --------- Cr√©ation AUTO (mock OCR hybride) ----------
      function ouvrirCreationAuto() {
        const bloc = document.getElementById("bloc_cre_auto");
        const blocManuel = document.getElementById("bloc_cre_manuel");
        bloc.style.display = "block";
        blocManuel.style.display = "none";
        const div = document.getElementById("cre_result");
        div.style.display = "none";
        div.textContent = "";
      }

      function ouvrirCreationManuelle() {
        const bloc = document.getElementById("bloc_cre_manuel");
        const blocAuto = document.getElementById("bloc_cre_auto");
        bloc.style.display = "block";
        blocAuto.style.display = "none";
        const div = document.getElementById("cre_result");
        div.style.display = "none";
        div.textContent = "";
      }

      function mockCreationAuto() {
        const div = document.getElementById("cre_result");
        div.style.display = "block";

        if (!lastScan || lastScan.existe) {
          div.textContent = "‚ùå Il faut d'abord scanner un ID inconnu mais cr√©able.";
          return;
        }

        const pcCode = document.getElementById("cre_point_code").value.trim();
        const pcLib = document.getElementById("cre_point_lib").value.trim();
        if (!pcCode || !pcLib) {
          div.textContent = "‚ùå Merci de renseigner le point de collecte (code + libell√©).";
          return;
        }

        const marque =
          document.getElementById("cre_ocr_marque").value.trim() || "(marque OCR simul√©e)";
        const modele =
          document.getElementById("cre_ocr_modele").value.trim() || "(mod√®le OCR simul√©)";
        const serie =
          document.getElementById("cre_ocr_serie").value.trim() || "(s√©rie OCR simul√©e)";
        const annee =
          document.getElementById("cre_ocr_annee").value.trim() || "(ann√©e OCR simul√©e)";

        const lignes = [];
        lignes.push("‚úÖ Cr√©ation AUTO (mock) enregistr√©e c√¥t√© front (sans appel API).");
        lignes.push("");
        lignes.push("ID traca           : " + lastScan.id_traca);
        lignes.push("Point de collecte  : " + pcCode + " ‚Äì " + pcLib);
        lignes.push("Marque (OCR)       : " + marque);
        lignes.push("Mod√®le (OCR)       : " + modele);
        lignes.push("S√©rie (OCR)        : " + serie);
        lignes.push("Ann√©e (OCR)        : " + annee);
        lignes.push("");
        lignes.push(
          "√âtape suivante JARVIS : envoyer ces donn√©es vers l'API /collecte/creer + flux OCR."
        );

        div.textContent = lignes.join("\n");
      }

      function mockCreationManuelle() {
        const div = document.getElementById("cre_result");
        div.style.display = "block";

        if (!lastScan || lastScan.existe) {
          div.textContent = "‚ùå Il faut d'abord scanner un ID inconnu mais cr√©able.";
          return;
        }

        const pcCode = document.getElementById("cre_point_code").value.trim();
        const pcLib = document.getElementById("cre_point_lib").value.trim();
        if (!pcCode || !pcLib) {
          div.textContent = "‚ùå Merci de renseigner le point de collecte (code + libell√©).";
          return;
        }

        const famille = document.getElementById("cre_famille").value.trim() || "(non renseign√©e)";
        const sousFamille =
          document.getElementById("cre_sous_famille").value.trim() || "(non renseign√©e)";
        const modele = document.getElementById("cre_modele").value.trim() || "(non renseign√©)";
        const poids = document.getElementById("cre_poids").value.trim() || "(non renseign√©)";

        const lignes = [];
        lignes.push("‚úÖ Cr√©ation MANUELLE (mock) enregistr√©e c√¥t√© front (sans appel API).");
        lignes.push("");
        lignes.push("ID traca           : " + lastScan.id_traca);
        lignes.push("Point de collecte  : " + pcCode + " ‚Äì " + pcLib);
        lignes.push("Famille            : " + famille);
        lignes.push("Sous-famille       : " + sousFamille);
        lignes.push("Mod√®le             : " + modele);
        lignes.push("Poids (kg)         : " + poids);
        lignes.push("");
        lignes.push(
          "√âtape suivante JARVIS : envoyer ces donn√©es vers l'API /collecte/creer (mode manuel)."
        );

        div.textContent = lignes.join("\n");
      }

      // Bind des √©v√©nements
      document.getElementById("btn_scan").addEventListener("click", doScan);
      document.getElementById("btn_cre_auto").addEventListener("click", ouvrirCreationAuto);
      document.getElementById("btn_cre_manuel").addEventListener("click", ouvrirCreationManuelle);
      document
        .getElementById("btn_valider_cre_auto")
        .addEventListener("click", mockCreationAuto);
      document
        .getElementById("btn_valider_cre_manuel")
        .addEventListener("click", mockCreationManuelle);
    </script>
  </body>
</html>
